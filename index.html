<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Clipz 2.5</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { margin: 0; padding: 0; background: black; color: white; font-family: Arial, sans-serif; overflow: hidden; }
    .section { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
    .btn { margin: 10px; padding: 10px 20px; background: #444; color: white; border: none; cursor: pointer; }
    .feed { height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; }
    .feed video { width: 100%; height: 100vh; object-fit: cover; scroll-snap-align: start; }
    .profile-pic { width: 100px; height: 100px; border-radius: 50%; margin: 10px; object-fit: cover; }
    .bottom-nav { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; justify-content: space-around; padding: 10px; }
    .uploads { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; }
    .uploads video { width: 100%; height: auto; }
    input, button { margin: 5px; padding: 10px; font-size: 16px; }
    #searchResults div { margin: 5px; padding: 5px; cursor: pointer; border-bottom: 1px solid #555; }
    .warning { color: red; }
  </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="section" style="display: flex;">
  <h1>Login</h1>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPassword" type="password" placeholder="Password">
  <button class="btn" onclick="login()">Login</button>
  <button class="btn" onclick="showSignup()">Sign Up</button>
</div>

<!-- Signup Screen -->
<div id="signupScreen" class="section">
  <h1>Sign Up</h1>
  <input id="signupEmail" placeholder="Email">
  <input id="signupPassword" type="password" placeholder="Password">
  <input id="signupUsername" placeholder="Username">
  <input id="signupPfp" type="file" accept="image/*">
  <div id="usernameError" class="warning"></div>
  <button class="btn" onclick="createAccount()">Create Account</button>
  <button class="btn" onclick="showLogin()">Back to Login</button>
</div>

<!-- Home Screen -->
<div id="homeScreen" class="section">
  <h1>Clipz</h1>
  <input id="searchInput" placeholder="Search Username" oninput="searchUsers()">
  <div id="searchResults"></div>
  <input id="uploadVideo" type="file" accept="video/*" onchange="uploadVideo()">
  <div id="uploadProgress"></div>
  <button id="loginLogoutBtn" class="btn" onclick="logout()">Log Out</button>
</div>

<!-- Feed Screen -->
<div id="feedScreen" class="section">
  <div id="feedList" class="feed"></div>
</div>

<!-- Profile Screen -->
<div id="profileScreen" class="section">
  <img id="profilePic" class="profile-pic" src="clipz pfp.jpg">
  <h2 id="profileUsername">Username</h2>
  <div id="followerCount">Followers: 0</div>
  <button id="followBtn" class="btn" onclick="followUser()">Follow</button>
  <div id="uploadsList" class="uploads"></div>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav" id="bottomNav" style="display:none;">
  <div class="nav-icon" onclick="showHome()">üè†</div>
  <div class="nav-icon" onclick="showFeed()">‚ñ∂Ô∏è</div>
  <div class="nav-icon" onclick="showProfile()">üë§</div>
</div>

<!-- REAL FULL SCRIPT CONTINUES BELOW -->
<script type="module">
const supabase = window.supabase.createClient(
  "https://mxrswdcphtnclkioeprj.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im14cnN3ZGNwaHRuY2xraW9lcHJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwODY4MDcsImV4cCI6MjA2MDY2MjgwN30.XjwMaypnmM_RqLkxjKWjw-JbEc9B4bxyoFaxj-Amo_s"
);

// GLOBALS
let viewingUserId = null;
let currentProfile = null;

// Hide all screens
window.hideAll = function() {
  document.querySelectorAll('.section').forEach(div => div.style.display = 'none');
};

// Show login screen
window.showLogin = function() {
  hideAll();
  document.getElementById('loginScreen').style.display = 'flex';
};

// Show signup screen
window.showSignup = function() {
  hideAll();
  document.getElementById('signupScreen').style.display = 'flex';
};

// Show home screen
window.showHome = function() {
  hideAll();
  document.getElementById('homeScreen').style.display = 'flex';
  document.getElementById('bottomNav').style.display = 'flex';
};

// Show feed screen
window.showFeed = function() {
  hideAll();
  document.getElementById('feedScreen').style.display = 'flex';
  document.getElementById('bottomNav').style.display = 'flex';
  loadFeed();
};

// Show profile screen
window.showProfile = async function() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return showLogin();
  loadProfile(user.id);
};
<script type="module">

const supabase = window.supabase.createClient(
  "https://mxrswdcphtnclkioeprj.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im14cnN3ZGNwaHRuY2xraW9lcHJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwODY4MDcsImV4cCI6MjA2MDY2MjgwN30.XjwMaypnmM_RqLkxjKWjw-JbEc9B4bxyoFaxj-Amo_s"
);

window.showLogin = function() {
  hideAll();
  document.getElementById('loginScreen').style.display = 'flex';
};

window.showSignup = function() {
  hideAll();
  document.getElementById('signupScreen').style.display = 'flex';
};

window.showHome = function() {
  hideAll();
  document.getElementById('homeScreen').style.display = 'flex';
  document.getElementById('bottomNav').style.display = 'flex';
};

window.showFeed = function() {
  hideAll();
  document.getElementById('feedScreen').style.display = 'flex';
  document.getElementById('bottomNav').style.display = 'flex';
  loadFeed();
};

window.showProfile = async function() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return showLogin();
  loadProfile(user.id);
};

window.hideAll = function() {
  document.querySelectorAll('.section').forEach(section => section.style.display = 'none');
  document.getElementById('bottomNav').style.display = 'none';
};

window.createAccount = async function() {
  const email = document.getElementById('signupEmail').value;
  const password = document.getElementById('signupPassword').value;
  const username = document.getElementById('signupUsername').value;
  const pfpFile = document.getElementById('signupPfp').files[0];

  const { data: existing } = await supabase.from('profiles').select().eq('username', username).maybeSingle();
  if (existing) {
    document.getElementById('usernameError').innerText = "Sorry, that username is taken.";
    return;
  }

  const { data: signup, error } = await supabase.auth.signUp({ email, password });
  if (error) { alert(error.message); return; }

  let pfpUrl = 'clipz pfp.jpg';
  if (pfpFile) {
    const { data: uploadData } = await supabase.storage.from('pfps').upload(`pfps/${Date.now()}_${pfpFile.name}`, pfpFile);
    pfpUrl = supabase.storage.from('pfps').getPublicUrl(uploadData.path).data.publicUrl;
  }

  await supabase.from('profiles').insert([{ id: signup.user.id, username, pfp_url: pfpUrl, followers: 0 }]);
  showLogin();
};

window.login = async function() {
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) alert(error.message);
  else showHome();
};

window.logout = async function() {
  await supabase.auth.signOut();
  showLogin();
};

window.loadProfile = async function(userId) {
  hideAll();
  document.getElementById('profileScreen').style.display = 'flex';
  document.getElementById('bottomNav').style.display = 'flex';

  const { data: profile } = await supabase.from('profiles').select().eq('id', userId).single();
  if (profile) {
    document.getElementById('profileUsername').innerText = profile.username;
    document.getElementById('profilePic').src = profile.pfp_url || 'clipz pfp.jpg';
    document.getElementById('followerCount').innerText = `Followers: ${profile.followers}`;
  }
};

window.searchUsers = async function() {
  const query = document.getElementById('searchInput').value;
  const { data } = await supabase.from('profiles').select().ilike('username', `%${query}%`);
  const results = document.getElementById('searchResults');
  results.innerHTML = '';
  if (data) {
    data.forEach(profile => {
      const div = document.createElement('div');
      div.innerText = profile.username;
      div.onclick = () => loadProfile(profile.id);
      results.appendChild(div);
    });
  }
};

window.uploadVideo = async function() {
  const file = document.getElementById('uploadVideo').files[0];
  if (!file) return;
  const path = `uploads/${Date.now()}_${file.name}`;
  let { data, error } = await supabase.storage.from('videos').upload(path, file);
  if (error) {
    alert('Upload failed.');
  } else {
    document.getElementById('uploadProgress').innerText = 'Upload complete!';
    loadFeed();
  }
};

window.loadFeed = async function() {
  const { data } = await supabase.storage.from('videos').list('uploads');
  const feedList = document.getElementById('feedList');
  feedList.innerHTML = '';

  if (data) {
    data.forEach(file => {
      const url = supabase.storage.from('videos').getPublicUrl('uploads/' + file.name).data.publicUrl;
      const vid = document.createElement('video');
      vid.src = url;
      vid.controls = false;
      vid.muted = false;
      vid.autoplay = true;
      vid.loop = true;
      vid.volume = 1.0;
      vid.style.objectFit = 'cover';
      feedList.appendChild(vid);
    });
  }
  setupSnapScroll();
};

function setupSnapScroll() {
  const feed = document.getElementById('feedList');
  feed.addEventListener('scroll', () => {
    const videos = feed.querySelectorAll('video');
    let closest = null;
    let closestDistance = Infinity;
    videos.forEach(video => {
      const rect = video.getBoundingClientRect();
      const distance = Math.abs(rect.top);
      if (distance < closestDistance) {
        closest = video;
        closestDistance = distance;
      }
    });
    videos.forEach(video => {
      if (video === closest) {
        video.play();
        video.muted = false;
        video.volume = 1.0;
      } else {
        video.pause();
      }
    });
  });
}

window.followUser = async function() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user || !viewingUserId) return;

  const { data: existingFollow } = await supabase.from('follows')
    .select()
    .eq('follower_id', user.id)
    .eq('following_id', viewingUserId)
    .maybeSingle();

  if (existingFollow) {
    await supabase.from('follows').delete().match({ follower_id: user.id, following_id: viewingUserId });
  } else {
    await supabase.from('follows').insert([{ follower_id: user.id, following_id: viewingUserId }]);
  }
  loadProfile(viewingUserId);
};

window.showLogin(); // Start at login screen by default

</script>
</body>
</html>
